<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collaboration Hub - Quantum Forge</title>
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="../styles/imports.css">
    
    <!-- Preload critical fonts -->
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" as="style">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <meta name="description" content="Collaboration Hub - Connect, share, and work together seamlessly">
    <meta name="theme-color" content="#4f46e5">
</head>
<body data-page="collaboration">
    <!-- Skip Links for Accessibility -->
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <!-- Live region for dynamic announcements -->
    <div aria-live="polite" aria-atomic="true" class="live-region" id="announcements"></div>

    <div class="dashboard" role="application">
        <!-- Header will be injected here -->
        <app-header></app-header>

        <div class="main-container">
            <!-- Enhanced Sidebar -->
            <app-sidebar></app-sidebar>

            <!-- Main Content -->
            <main id="main-content" class="main-content" role="main" aria-label="Collaboration Hub">
                <div class="page-header">
                    <div class="page-title-section">
                        <div class="page-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                <circle cx="9" cy="7" r="4"></circle>
                                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                            </svg>
                        </div>
                        <div>
                            <h1 class="page-title">Collaboration Hub</h1>
                            <p class="page-description">Connect, share, and work together seamlessly</p>
                        </div>
                    </div>
                    <div class="page-actions">
                        <button class="btn secondary" id="refreshBtn">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="23 4 23 10 17 10"></polyline>
                                <polyline points="1 20 1 14 7 14"></polyline>
                                <path d="m3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                            </svg>
                            Refresh
                        </button>
                        <button class="btn primary" id="newCollabBtn">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 5v14M5 12h14"></path>
                            </svg>
                            New Collaboration
                        </button>
                    </div>
                </div>

                <!-- Collaboration Hub Content -->
                <div class="collaboration-grid" style="display: grid; gap: 1.5rem; grid-template-columns: 2fr 1fr; grid-template-areas: 
                    'collab chat'
                    'collab workspaces'
                    'activity activity';">
                    <!-- Active Collaborations - Taller, primary focus -->
                    <div class="dashboard-item" style="grid-area: collab; min-height: 700px; height: auto; overflow: visible;">
                        <collaboration-hub></collaboration-hub>
                    </div>

                    <!-- Team Chat Widget - Adjustable height -->
                    <div class="dashboard-item" style="grid-area: chat; min-height: 500px; height: auto; overflow: visible;">
                        <team-chat-widget></team-chat-widget>
                    </div>

                    <!-- Shared Workspaces - Adjustable list view -->
                    <div class="dashboard-item" style="grid-area: workspaces; min-height: 400px; height: auto; overflow: visible;">
                        <div class="widget-header">
                            <h2 class="widget-title">Shared Workspaces</h2>
                            <button class="btn-icon" aria-label="Manage workspaces">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="3"></circle>
                                    <circle cx="12" cy="12" r="1"></circle>
                                    <circle cx="12" cy="12" r="8"></circle>
                                </svg>
                            </button>
                        </div>
                        <div class="workspaces-list">
                            <div class="workspace-item" data-workspace="project-alpha">
                                <div class="workspace-icon">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polygon points="12 2 2 7 12 12 22 7 12 2"></polygon>
                                        <polyline points="2 17 12 22 22 17"></polyline>
                                        <polyline points="2 12 12 17 22 12"></polyline>
                                    </svg>
                                </div>
                                <div class="workspace-details">
                                    <h3>Project Alpha</h3>
                                    <p>8 members • Last updated 2h ago</p>
                                </div>
                                <button class="btn secondary btn-sm workspace-join-btn" data-workspace="project-alpha">Join</button>
                            </div>
                            <div class="workspace-item" data-workspace="design-sprint">
                                <div class="workspace-icon">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="12" cy="12" r="10"></circle>
                                        <circle cx="12" cy="12" r="4"></circle>
                                        <line x1="12" y1="2" x2="12" y2="6"></line>
                                        <line x1="12" y1="18" x2="12" y2="22"></line>
                                    </svg>
                                </div>
                                <div class="workspace-details">
                                    <h3>Design Sprint</h3>
                                    <p>12 members • Active now</p>
                                </div>
                                <button class="btn primary btn-sm workspace-join-btn" data-workspace="design-sprint">Join</button>
                            </div>
                            
                            <script>
                                // Handle workspace join buttons
                                document.querySelectorAll('.workspace-join-btn').forEach(btn => {
                                    btn.addEventListener('click', function(e) {
                                        const workspaceId = e.target.dataset.workspace;
                                        const workspaceTitle = e.target.closest('.workspace-item').querySelector('h3').textContent;
                                        
                                        // Create join confirmation modal
                                        const modal = document.createElement('div');
                                        modal.className = 'workspace-join-modal';
                                        modal.innerHTML = `
                                            <div class="modal-content">
                                                <div class="modal-header">
                                                    <h2>Join ${workspaceTitle}</h2>
                                                    <button class="close-modal-btn">&times;</button>
                                                </div>
                                                <div class="modal-body">
                                                    <p>You're about to join the workspace "${workspaceTitle}". You'll have access to:</p>
                                                    <ul>
                                                        <li>Shared files and resources</li>
                                                        <li>Team chat and collaboration tools</li>
                                                        <li>Project updates and notifications</li>
                                                    </ul>
                                                    <div class="workspace-preview">
                                                        <img src="../assets/workspace-previews/${workspaceId}.png" 
                                                             alt="Workspace preview" 
                                                             onerror="this.src='../assets/workspace-previews/default.png'">
                                                    </div>
                                                </div>
                                                <div class="modal-footer">
                                                    <button class="btn secondary" id="cancelJoin">Cancel</button>
                                                    <button class="btn primary" id="confirmJoin">Join Workspace</button>
                                                </div>
                                            </div>
                                        `;
                                        document.body.appendChild(modal);

                                        // Add modal interactions
                                        const closeModal = () => {
                                            modal.classList.add('fade-out');
                                            setTimeout(() => modal.remove(), 300);
                                        };

                                        modal.querySelector('.close-modal-btn').addEventListener('click', closeModal);
                                        modal.querySelector('#cancelJoin').addEventListener('click', closeModal);
                                        
                                        modal.querySelector('#confirmJoin').addEventListener('click', function() {
                                            // Join workspace logic
                                            e.target.textContent = 'Joined';
                                            e.target.classList.remove('primary', 'secondary');
                                            e.target.classList.add('success');
                                            e.target.disabled = true;

                                            // Update members count
                                            const membersText = e.target.closest('.workspace-item').querySelector('p');
                                            const currentCount = parseInt(membersText.textContent);
                                            membersText.textContent = membersText.textContent.replace(
                                                /(\d+) members/,
                                                `${currentCount + 1} members • You joined just now`
                                            );

                                            // Update activity feed
                                            const activityFeed = document.querySelector('live-activity-feed');
                                            if (activityFeed) {
                                                activityFeed.addRandomActivity(true, {
                                                    type: 'collaboration',
                                                    message: `You joined the "${workspaceTitle}" workspace`
                                                });
                                            }

                                            closeModal();
                                        });

                                        // Show modal with animation
                                        requestAnimationFrame(() => modal.classList.add('active'));
                                    });
                                });
                            </script>
                        </div>
                    </div>

                    <!-- Recent Activity - Full width but compact -->
                    <div class="dashboard-item" style="grid-area: activity; max-height: 300px;">
                        <live-activity-feed></live-activity-feed>
                    </div>
                </div>

                <style>
                    /* Enhanced Grid Layout Styles */
                    .collaboration-grid {
                        margin: 1.5rem 0;
                    }

                    .dashboard-item {
                        background: var(--bg-elevated);
                        border-radius: var(--radius-lg);
                        box-shadow: var(--shadow-sm);
                        overflow: hidden;
                        transition: all 0.3s ease;
                    }

                    /* Proper spacing and padding */
                    .widget-header {
                        padding: 1rem 1.5rem;
                        border-bottom: 1px solid var(--border-color);
                    }

                    .workspaces-list {
                        padding: 1rem;
                        overflow-y: auto;
                        max-height: calc(300px - 4rem); /* Account for header */
                    }

                    .workspace-item {
                        padding: 1rem;
                        border-radius: var(--radius-md);
                        border: 1px solid var(--border-color);
                        margin-bottom: 0.75rem;
                        display: flex;
                        align-items: center;
                        gap: 1rem;
                    }

                    .workspace-item:last-child {
                        margin-bottom: 0;
                    }

                    /* Ensure content doesn't overflow */
                    .dashboard-item > * {
                        height: 100%;
                        overflow-y: auto;
                        scrollbar-width: thin;
                    }

                    /* Responsive adjustments */
                    @media (max-width: 1024px) {
                        .collaboration-grid {
                            grid-template-columns: 1fr;
                            grid-template-areas: 
                                'collab'
                                'chat'
                                'workspaces'
                                'activity';
                        }

                        .dashboard-item {
                            max-height: none !important;
                            min-height: 0 !important;
                        }
                    }
                </style>
                </div>
            </main>
        </div>
    </div>

    <!-- Scripts -->
    <script src="../js/components/header.js"></script>
    <script src="../js/components/sidebar.js"></script>
    <script src="../js/components/collaboration-hub.js"></script>
    <script src="../js/components/team-chat-widget.js"></script>
    <script src="../js/components/live-activity-feed.js"></script>
    <script src="../js/app.js"></script>

    <script>
        // Page-specific initialization
        document.addEventListener('DOMContentLoaded', function() {
            // Set active sidebar item
            const sidebar = document.querySelector('app-sidebar');
            if (sidebar && sidebar.setActivePage) {
                sidebar.setActivePage('collaboration');
            }

            // Initialize page actions
            setupPageActions();
        });

        function setupPageActions() {
            const refreshBtn = document.getElementById('refreshBtn');
            const newCollabBtn = document.getElementById('newCollabBtn');

            if (refreshBtn) {
                refreshBtn.addEventListener('click', function() {
                    // Show refresh animation
                    refreshBtn.classList.add('rotating');
                    
                    // Refresh all dynamic components
                    const components = [
                        document.querySelector('collaboration-hub'),
                        document.querySelector('team-chat-widget'),
                        document.querySelector('live-activity-feed')
                    ];
                    
                    // Sequential refresh with visual feedback
                    const refreshSequence = async () => {
                        for (const component of components) {
                            if (component) {
                                // Add shimmer effect
                                component.classList.add('refreshing');
                                
                                // Wait for component refresh
                                if (component.refreshActivities) {
                                    await component.refreshActivities();
                                } else if (component.loadMockData) {
                                    await component.loadMockData();
                                }
                                
                                // Remove shimmer
                                component.classList.remove('refreshing');
                                
                                // Small delay between components
                                await new Promise(resolve => setTimeout(resolve, 300));
                            }
                        }
                        
                        // Reset refresh button
                        refreshBtn.classList.remove('rotating');
                        
                        // Show success feedback
                        const notification = document.createElement('div');
                        notification.className = 'refresh-notification';
                        notification.textContent = '✨ Collaboration data refreshed';
                        document.body.appendChild(notification);
                        
                        setTimeout(() => {
                            notification.classList.add('fade-out');
                            setTimeout(() => notification.remove(), 300);
                        }, 2000);
                    };
                    
                    refreshSequence();
                });
            }

            if (newCollabBtn) {
                newCollabBtn.addEventListener('click', function() {
                    const modal = document.createElement('div');
                    modal.className = 'collaboration-modal';
                    modal.innerHTML = `
                        <div class="modal-content">
                            <div class="modal-header">
                                <h2>Create New Collaboration</h2>
                                <button class="close-modal-btn">&times;</button>
                            </div>
                            <div class="modal-body">
                                <form id="newCollabForm">
                                    <div class="form-group">
                                        <label for="collabName">Collaboration Name</label>
                                        <input type="text" id="collabName" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="collabType">Type</label>
                                        <select id="collabType" required>
                                            <option value="project">Project</option>
                                            <option value="workshop">Workshop</option>
                                            <option value="brainstorm">Brainstorm</option>
                                            <option value="other">Other</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="collabDesc">Description</label>
                                        <textarea id="collabDesc" required></textarea>
                                    </div>
                                    <div class="form-group">
                                        <label for="collabMembers">Invite Members</label>
                                        <select id="collabMembers" multiple>
                                            <option value="sarah">Sarah Chen</option>
                                            <option value="mike">Mike Rodriguez</option>
                                            <option value="emily">Emily Davis</option>
                                            <option value="alex">Alex Johnson</option>
                                        </select>
                                    </div>
                                    <div class="modal-actions">
                                        <button type="button" class="btn secondary" id="cancelCollab">Cancel</button>
                                        <button type="submit" class="btn primary">Create Collaboration</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(modal);

                    const closeBtn = modal.querySelector('.close-modal-btn');
                    const cancelBtn = modal.querySelector('#cancelCollab');
                    const form = modal.querySelector('#newCollabForm');

                    function closeModal() {
                        modal.classList.add('fade-out');
                        setTimeout(() => modal.remove(), 300);
                    }

                    closeBtn.addEventListener('click', closeModal);
                    cancelBtn.addEventListener('click', closeModal);

                    form.addEventListener('submit', function(e) {
                        e.preventDefault();
                        const collabHub = document.querySelector('collaboration-hub');
                        if (collabHub) {
                            collabHub.createCollaborativeSpace({
                                name: form.collabName.value,
                                type: form.collabType.value,
                                description: form.collabDesc.value,
                                members: Array.from(form.collabMembers.selectedOptions).map(opt => opt.text)
                            });
                        }
                        closeModal();
                    });

                    // Fade in animation
                    requestAnimationFrame(() => modal.classList.add('active'));
                });
            }
        }
    </script>
</body>
</html>
